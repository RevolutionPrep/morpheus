<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>association.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
        <a class="source" href="/polaris_resource/index.html">INDEX</a>
          <a class="source" href="../../ext/typhoeus.html">typhoeus.rb</a>
          <a class="source" href="../../polaris_client/associations.html">associations.rb</a>
          <a class="source" href="../../polaris_client/log_subscriber.html">log_subscriber.rb</a>
          <a class="source" href="../../polaris_client/railtie.html">railtie.rb</a>
          <a class="source" href="../../polaris_resource.html">polaris_resource.rb</a>
          <a class="source" href="association.html">association.rb</a>
          <a class="source" href="belongs_to_association.html">belongs_to_association.rb</a>
          <a class="source" href="has_many_association.html">has_many_association.rb</a>
          <a class="source" href="has_one_association.html">has_one_association.rb</a>
          <a class="source" href="../base.html">base.rb</a>
          <a class="source" href="../configuration.html">configuration.rb</a>
          <a class="source" href="../errors.html">errors.rb</a>
          <a class="source" href="../mixins/associations.html">associations.rb</a>
          <a class="source" href="../mixins/attributes.html">attributes.rb</a>
          <a class="source" href="../mixins/conversion.html">conversion.rb</a>
          <a class="source" href="../mixins/finders.html">finders.rb</a>
          <a class="source" href="../mixins/introspection.html">introspection.rb</a>
          <a class="source" href="../mixins/persistence.html">persistence.rb</a>
          <a class="source" href="../mixins/reflections.html">reflections.rb</a>
          <a class="source" href="../mixins/request_handling.html">request_handling.rb</a>
          <a class="source" href="../mixins/response_parsing.html">response_parsing.rb</a>
          <a class="source" href="../mock.html">mock.rb</a>
          <a class="source" href="../reflection.html">reflection.rb</a>
          <a class="source" href="../relation.html">relation.rb</a>
          <a class="source" href="../request.html">request.rb</a>
          <a class="source" href="../request_cache.html">request_cache.rb</a>
          <a class="source" href="../request_queue.html">request_queue.rb</a>
          <a class="source" href="../response.html">response.rb</a>
          <a class="source" href="../type_caster.html">type_caster.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>association.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>The Association class serves as the basis for associating resources.
Resources have an association DSL that follows that of ActiveRecord:</p>

<p>has_many :automobiles</p>

<p>has_one :car</p>

<p>belongs_to :car_club</p>

<p>This class acts as a proxy that will allow for lazy evaluation of an
association. The proxy waits to make the request for the object until
a method on the association is called. When this happens, because the
method does not exist on the proxy object, method_missing will be
called, the target object will be loaded, and then the method will be
called on the loaded target.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">PolarisResource</span>
  <span class="k">module</span> <span class="nn">Associations</span>
    <span class="k">class</span> <span class="nc">Association</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">BasicObject</span>
      
      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">association</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>@owner stores the class that the association exists on.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="vi">@owner</span>       <span class="o">=</span> <span class="n">owner</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>@association stores the associated class, as named in the association
method (i.e. :automobile, :car, :car_club)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="vi">@association</span> <span class="o">=</span> <span class="n">association</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>@target stores the loaded object. It is not typically accessed directly,
but instead should be accessed through the loaded_target method.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="vi">@target</span>      <span class="o">=</span> <span class="n">target</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>@options holds the chosen options for the association.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="vi">@options</span>     <span class="o">=</span> <span class="p">{}</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Associations can be marked as polymorphic. These associations will use
the returned found type to instantiate the associated object.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:polymorphic</span><span class="o">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:polymorphic</span><span class="o">]</span> <span class="o">||</span> <span class="kp">false</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>In some cases, the association name will not match that of the class
that should be instantiated when it is invoked. Here, we can specify
that this association uses a specified class as its target. When the
request is made for the association, this class will be used to
instantiate this object or collection.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:class_name</span><span class="o">]</span>  <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:class_name</span><span class="o">]</span>  <span class="o">||</span> <span class="vi">@association</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">classify</span>
      <span class="k">end</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>The proxy implements a few methods that need to be overridden
so that they will work as expected.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">id</span>
        <span class="n">loaded_target</span><span class="o">.</span><span class="n">id</span>
      <span class="k">end</span>
      
      <span class="k">def</span> <span class="nf">nil?</span>
        <span class="n">loaded_target</span><span class="o">.</span><span class="n">nil?</span>
      <span class="k">end</span>
      
      <span class="k">def</span> <span class="nf">to_param</span>
        <span class="n">loaded_target</span><span class="o">.</span><span class="n">to_param</span>
      <span class="k">end</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>The stub method can be used to mock out an association without
having to really load the target.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">stub</span><span class="p">(</span><span class="n">mock</span><span class="p">)</span>
        <span class="vi">@mock</span> <span class="o">=</span> <span class="n">mock</span>
      <span class="k">end</span>
      
      <span class="kp">private</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>This is left to be implemented by the subclasses as it will operate
differently in each case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">load_target!</span>
      <span class="k">end</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>The loaded_target method holds a cached version of the loaded target.
This method is used to access the proxied object. Since a request will
be made when a method is invoked on the object, and this can happen
very often, we are caching the target here, so that only a single
request will be made.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">loaded_target</span>
        <span class="k">return</span> <span class="vi">@mock</span> <span class="k">if</span> <span class="vi">@mock</span>
        <span class="vi">@target</span> <span class="o">||=</span> <span class="n">load_target!</span>
      <span class="k">end</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>The method_missing hook will be called when methods that do not exist
on the proxy object are invoked. This is the point at which the proxied
object is loaded, if it has not been loaded already.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loaded_target</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
          <span class="n">loaded_target</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="k">super</span>
        <span class="k">end</span>
      <span class="k">end</span>
      
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>